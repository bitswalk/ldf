name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

env:
  GO_VERSION: "1.24"
  CGO_ENABLED: 1

jobs:
  release:
    name: Build and Release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - uses: oven-sh/setup-bun@v2

      - uses: arduino/setup-task@v2
        with:
          version: 3.x

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y gcc libsqlite3-dev

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=$GITHUB_REF_NAME" >> "$GITHUB_OUTPUT"

      - name: Run linter
        uses: golangci/golangci-lint-action@v6
        with:
          args: ./src/...

      - name: Run tests
        run: |
          go test -race ./src/ldfd/...
          go test -race ./src/ldfctl/...

      - name: Run WebUI tests
        working-directory: src/webui
        run: |
          bun install --frozen-lockfile
          bun run test

      - name: Build all
        run: task build

      - name: Verify version stamp
        run: ./build/bin/ldfctl version

      - name: Package release assets
        run: |
          VERSION=${{ steps.version.outputs.version }}
          mkdir -p build/release
          tar -czf build/release/ldfd-v${VERSION}-linux-amd64.tar.gz -C build/bin ldfd
          tar -czf build/release/ldfctl-v${VERSION}-linux-amd64.tar.gz -C build/bin ldfctl
          cd build/release && sha256sum *.tar.gz > checksums-v${VERSION}-sha256.txt

      - name: Find previous tag
        id: prev
        run: |
          PREV_TAG=$(git tag --sort=-version:refname | grep '^v' | sed -n '2p')
          echo "tag=${PREV_TAG:-}" >> "$GITHUB_OUTPUT"

      - name: Create GitHub release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION=${{ steps.version.outputs.version }}
          TAG=${{ steps.version.outputs.tag }}
          PREV_TAG=${{ steps.prev.outputs.tag }}
          if [ -f RELEASE_NOTES.md ]; then
            NOTES_FLAG="--notes-file RELEASE_NOTES.md"
          elif [ -n "$PREV_TAG" ]; then
            NOTES_FLAG="--generate-notes --notes-start-tag $PREV_TAG"
          else
            NOTES_FLAG="--generate-notes"
          fi
          gh release create "$TAG" \
            --title "$TAG" \
            $NOTES_FLAG \
            build/release/ldfd-v${VERSION}-linux-amd64.tar.gz \
            build/release/ldfctl-v${VERSION}-linux-amd64.tar.gz \
            build/release/checksums-v${VERSION}-sha256.txt
